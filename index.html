<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Document</title>
   <!-- Только CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<!-- Пакет JavaScript с Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</head>
<body>
   <!-- 
   <div class="app">
      <header class="header">
         <img src="" alt="Logo" class="logo">
      </header>
      <div class="clock h2">
        Time: 12-12-12
      </div>
      <div class="lots container">
         <article class="lot card">
            <div class="card-body">
            <div class="price card-text">
               16
            </div>
            <h1 class="card-title">Title</h1>
            <p class="card-text">Description</p>
            
            <hr>
         </article>
      </div>
   </div>
   -->
   <div id="root">

   </div>
   <script>
      // api method
      const api = {
         get(url) {
            switch(url) {

               case '/lots': 
                  return new Promise((resolve,reject) => {
                     setTimeout(() => {
                       resolve([  
             {
               id:1,
               name:'Lot 1',
               description:"This is first Lot",
               price:15
            },
            {
               id:2,
               name:'Lot 2',
               description:"This is Second Lot",
               price:152
            }

            ])
                     },2000)
                  });

               
               default: 
                   throw new Error('url not found');

            }
         }
      }
      //websoket
      const stream = {
         subscribe(channel,listener) {
            const match = /price-(\d+)/.exec(channel);
            if(match) {
               setInterval(() => {
                  listener({
                     
                        id: parseInt(match[1]),
                        price: Math.round((Math.random()*10+30))
                     
                  })
               }, 400);
            }
         }
      }
      //state(data)
      let state = {
         time:new Date(),
         lots: null,
      };
      //App page element
      function App({state}) {
      const app = document.createElement('div');
      app.classList.add('app','container');
      app.append(Header());
      app.append(Clock({
         time:state.time,
      }));
      app.append(Lots({lots:state.lots}));
      return app;
    }
      
      //components
      function Header () {
      const header = document.createElement('header');
      header.classList.add('header');
      header.append(Logo());
      return header
      };

      function Logo() {
      const logo = document.createElement('img');
      logo.classList.add('logo');
      logo.src = "https://lh3.googleusercontent.com/ogw/ADea4I4TUGGafgyc3doOQsqb8cI3WnImEAMviVkjvX8C=s83-c-mo";
      return logo;
      }
      function Clock({time}) { 
     
      const node = document.createElement('div');
      node.classList.add('clock','d-flex');
      const value = document.createElement('span');
      value.classList.add('value','h2');
      value.innerText = "Time: " + time.toLocaleTimeString();

      node.append(value);

      const icon = document.createElement('div');
      icon.style.width = "40px";
      icon.style.height = "40px";
      if(time.getHours() >= 7 && time.getHours() <= 22) {
         icon.style.backgroundColor = "green";
      } else {
         icon.style.backgroundColor = "blue";
      }
      node.append(icon);
      return node;
      }

      function Lot({lot}) {
         const node = document.createElement('article');
         node.classList.add('lot','card','m-1');

         const price = document.createElement('div');
         price.classList.add('price','card-text');
         price.innerText ="Price " + lot.price;
         node.append(price);

         const name = document.createElement('h1');
         name.classList.add('name','card-title');
         name.innerText = lot.name;
         node.append(name);

         
         const description = document.createElement('p');
         description.classList.add('description','card-text');
         description.innerText = lot.description;
         node.append(description);
         return node;
      } 
      
      function Loading() {
            const node = document.createElement('div');
            node.classList.add('alert','alert-primary');
            node.innerText = "Loading...";
            return node;
      }
      function Lots({lots}) {
         if(lots === null) {
            return Loading();
         }
      const list = document.createElement('div');
      list.classList.add("lots","container");
      lots.forEach((lot) => {

         list.append(Lot({lot}));

      })
      return list;
   }
      // rendering
     function renderView(state) {
        render(
           App({state}),
           document.getElementById('root')
        )
     }
     renderView(state);
   //rerender dom 1sec
      setInterval(() => {
         state = {
            ...state,
            time:new Date(), 
         }

         renderView(state);
      },1000)

      api.get('/lots').then((lots) => {
         state = {
            ...state,
            lots
         }
         renderView(state)

         const onPrice = (data) => {
         
            state = {
               ...state,
               lots:state.lots.map((lot) => {
                  if(lot.id === data.id) {
                  return {
                     ...lot,
                     price: Math.round(Math.random() * 10 + 30)
                  }
               }
               return lot
               })
            }
            renderView(state)
         }
         lots.forEach((lot) => {
            stream.subscribe(`price-${lot.id}`,onPrice);
         })
      })

      function render(newDom,realDomRoot) {
         realDomRoot.innerHTML = "";
         realDomRoot.append(newDom);
      }
   </script>

</body>
</html>